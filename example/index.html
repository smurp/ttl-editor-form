<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTL Editor Form - Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .demo-section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 15px;
        }
        .logged-out {
            background: #f8d7da;
            color: #721c24;
        }
        .logged-in {
            background: #d4edda;
            color: #155724;
        }
        .toggle-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .toggle-button:hover {
            background: #0056b3;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üê¢ TTL Editor Form Demo</h1>
    
    <div class="demo-section">
        <h2>
            Demo 1: Not Logged In
            <span class="status-indicator logged-out" id="status1">NOT LOGGED IN</span>
        </h2>
        <div class="info">
            When not authenticated, the submit button is disabled even if the TTL is valid.
        </div>
        <ttl-editor-form id="form1"></ttl-editor-form>
        <button class="toggle-button" onclick="toggleLogin1()">Toggle Login Status</button>
    </div>
    
    <div class="demo-section">
        <h2>
            Demo 2: Logged In
            <span class="status-indicator logged-in" id="status2">LOGGED IN: mailto:alice@example.com</span>
        </h2>
        <div class="info">
            When authenticated, you can submit valid TTL. Try pasting some Turtle and watch the validation.
        </div>
        <ttl-editor-form id="form2"></ttl-editor-form>
        <button class="toggle-button" onclick="toggleLogin2()">Toggle Login Status</button>
    </div>
    
    <!-- CRITICAL: Import mntl-space-fab BEFORE ttl-editor-form -->
    <script type="module">
        // Inline the mntl-space-fab for demo purposes (normally would be npm package)
        // Or use: import 'https://unpkg.com/@mmmlib/mntl-space-fab/src/mntl-space-fab.js';
        
        // For local dev, assuming mntl-space-fab is in sibling directory:
        const DEFAULT_TYPES = [
          { value: 'mntl:open', label: 'mntl:open/{identity}',
            description: 'mntl:open - Owned by you, readable by the world' },
          { value: 'mntl:publ', label: 'mntl:publ',
            description: 'mntl:publ - A true public commons' }
        ];

        class MntlSpaceFabWC extends HTMLElement {
          constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this._currentIdentity = null;
            this._acceptedTypes = [...DEFAULT_TYPES];
            this._mentalSpace = 'mntl:publ';
            this._path = '/';
          }
          
          get currentIdentity() { return this._currentIdentity; }
          set currentIdentity(v) { this._currentIdentity = v; this.render(); }
          
          get acceptedTypes() { return this._acceptedTypes; }
          set acceptedTypes(t) { 
            if (Array.isArray(t) && t.length > 0) {
              this._acceptedTypes = t;
              if (!t.find(x => x.value === this._mentalSpace)) {
                this._mentalSpace = t[0].value;
              }
              this.render();
            }
          }
          
          get value() { return this.getFullUri(); }
          set value(uri) { this.parseUri(uri); this.render(); }
          
          connectedCallback() {
            this.render();
            this.attachEventListeners();
          }
          
          parseUri(uri) {
            if (!uri) return;
            for (const type of this._acceptedTypes) {
              const basePrefix = type.value;
              if (uri.startsWith(basePrefix)) {
                this._mentalSpace = type.value;
                if (type.label.includes('{identity}') && this._currentIdentity) {
                  const afterBase = uri.substring(basePrefix.length);
                  const firstSlash = afterBase.indexOf('/');
                  if (firstSlash !== -1) {
                    const secondSlash = afterBase.indexOf('/', firstSlash + 1);
                    this._path = secondSlash !== -1 ? afterBase.substring(secondSlash) : '/';
                  } else {
                    this._path = '/';
                  }
                } else {
                  this._path = uri.substring(basePrefix.length) || '/';
                }
                if (!this._path.startsWith('/')) this._path = '/' + this._path;
                return;
              }
            }
            this._path = uri.startsWith('/') ? uri : '/' + uri;
          }
          
          getFullUri() {
            const type = this._acceptedTypes.find(t => t.value === this._mentalSpace);
            if (!type) return this._mentalSpace + this._path;
            const cleanPath = this._path.startsWith('/') ? this._path : '/' + this._path;
            if (type.label.includes('{identity}') && this._currentIdentity) {
              return type.value + '/' + this._currentIdentity + cleanPath;
            } else {
              return type.value + cleanPath;
            }
          }
          
          getDesc() {
            const t = this._acceptedTypes.find(x => x.value === this._mentalSpace);
            return t ? t.description : '';
          }
          
          render() {
            const id = this._currentIdentity || '{identity}';
            this.shadowRoot.innerHTML = `
              <style>
                :host { display: block; font-family: system-ui, sans-serif; }
                .fab-container { display: flex; }
                select { 
                  padding: 10px 15px; border: 2px solid #ced4da;
                  border-right: none; border-radius: 6px 0 0 6px;
                  font-size: 14px; font-family: Monaco, monospace;
                  min-width: 240px; background: white; cursor: pointer;
                  text-align: right; direction: rtl;
                }
                select option { direction: ltr; text-align: left; }
                input { 
                  flex: 1; padding: 10px 15px; border: 2px solid #ced4da;
                  border-radius: 0 6px 6px 0; font-size: 14px;
                  font-family: Monaco, monospace;
                }
                select:focus { 
                  outline: none; border-color: #80bdff;
                  box-shadow: -0.2rem 0 0 0.2rem rgba(0,123,255,0.25); z-index: 1;
                }
                input:focus { 
                  outline: none; border-color: #80bdff;
                  box-shadow: 0.2rem 0 0 0.2rem rgba(0,123,255,0.25); z-index: 1;
                }
                .description { font-size: 12px; color: #6c757d; margin-top: 6px; font-style: italic; }
              </style>
              <div class="fab-container">
                <select id="ms">${this._acceptedTypes.map(t => {
                  const lbl = t.label.replace('{identity}', id);
                  const sel = this._mentalSpace === t.value ? 'selected' : '';
                  return `<option value="${t.value}" ${sel}>${lbl}</option>`;
                }).join('')}</select>
                <input type="text" id="path" placeholder="/path" value="${this._path}" />
              </div>
              <div class="description">${this.getDesc()}</div>
            `;
          }
          
          attachEventListeners() {
            const sel = this.shadowRoot.getElementById('ms');
            const inp = this.shadowRoot.getElementById('path');
            sel?.addEventListener('change', (e) => {
              this._mentalSpace = e.target.value;
              const desc = this.shadowRoot.querySelector('.description');
              if (desc) desc.textContent = this.getDesc();
              this.emitChange();
            });
            inp?.addEventListener('input', (e) => {
              let val = e.target.value;
              if (val && !val.startsWith('/')) {
                val = '/' + val;
                e.target.value = val;
              }
              this._path = val || '/';
              this.emitChange();
            });
            inp?.addEventListener('blur', (e) => {
              const normalized = e.target.value.startsWith('/') ? e.target.value : '/' + (e.target.value || '');
              if (normalized !== e.target.value) {
                e.target.value = normalized;
                this._path = normalized;
                this.emitChange();
              }
            });
          }
          
          emitChange() {
            this.dispatchEvent(new CustomEvent('graph-changed', {
              detail: { mentalSpace: this._mentalSpace, path: this._path, fullUri: this.getFullUri() },
              bubbles: true, composed: true
            }));
          }
          
          getValue() { return this.getFullUri(); }
          setValue(uri) { this.value = uri; }
        }
        
        customElements.define('mntl-space-fab', MntlSpaceFabWC);
    </script>
    
    <script type="module" src="../src/ttl-editor-form.js"></script>
    
    <script>
        customElements.whenDefined('ttl-editor-form').then(() => {
            const form1 = document.getElementById('form1');
            const form2 = document.getElementById('form2');
            
            form1.currentIdentity = null;
            
            form2.currentIdentity = 'mailto:alice@example.com';
            form2.defaultGraph = 'mntl:open/alice/notes';
            
            [form1, form2].forEach(form => {
                form.addEventListener('ttl-submitted', (e) => {
                    console.log('TTL submitted:', e.detail);
                    alert(`‚úÖ ${e.detail.tripleCount} triples submitted to ${e.detail.graph}`);
                });
                
                form.addEventListener('validation-changed', (e) => {
                    console.log('Validation:', e.detail);
                });
            });
        });
        
        function toggleLogin1() {
            const form = document.getElementById('form1');
            const status = document.getElementById('status1');
            
            if (form.currentIdentity) {
                form.currentIdentity = null;
                status.textContent = 'NOT LOGGED IN';
                status.className = 'status-indicator logged-out';
            } else {
                form.currentIdentity = 'mailto:bob@example.com';
                status.textContent = 'LOGGED IN: mailto:bob@example.com';
                status.className = 'status-indicator logged-in';
            }
        }
        
        function toggleLogin2() {
            const form = document.getElementById('form2');
            const status = document.getElementById('status2');
            
            if (form.currentIdentity) {
                form.currentIdentity = null;
                status.textContent = 'NOT LOGGED IN';
                status.className = 'status-indicator logged-out';
            } else {
                form.currentIdentity = 'mailto:alice@example.com';
                status.textContent = 'LOGGED IN: mailto:alice@example.com';
                status.className = 'status-indicator logged-in';
            }
        }
    </script>
</body>
</html>
